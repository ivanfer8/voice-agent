<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agente de voz</title>
</head>
<body>
  <h1>Agente de voz (prueba)</h1>
  <button id="btnToggle">Hablar</button>
  <pre id="log"></pre>

  <script>
  const btn = document.getElementById('btnToggle');
  const log = document.getElementById('log');

  let mediaRecorder;
  let socket;
  let isRecording = false;

  function addLog(msg) {
    log.textContent += msg + "\n";
  }

  btn.onclick = async () => {
    if (!isRecording) {
      // Abrir WebSocket al mismo host
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      socket = new WebSocket(`${protocol}://${location.host}`);
      socket.binaryType = "arraybuffer";

      socket.onopen = () => {
        addLog("WS conectado");

        // ðŸ”¹ MENSAJE DE PRUEBA DE TEXTO
        socket.send("TEST DESDE EL NAVEGADOR");
      };

      socket.onmessage = (event) => {
        addLog("Respuesta servidor: " + event.data);
      };

      socket.onclose = () => addLog("WS cerrado");
      socket.onerror = (e) => addLog("WS error: " + e.message);

      // Pedir micro
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      // Importante: dejamos que el navegador elija el formato
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.onstart = () => {
        addLog("MediaRecorder iniciado");
      };

      mediaRecorder.ondataavailable = (e) => {
        addLog("Chunk de audio generado, tamaÃ±o: " + e.data.size);

        if (e.data.size > 0 && socket.readyState === WebSocket.OPEN) {
          e.data.arrayBuffer().then(buf => {
            socket.send(buf);  // ðŸ”¹ Enviamos audio al servidor
          });
        }
      };

      mediaRecorder.onstop = () => {
        addLog("MediaRecorder parado");
      };

      mediaRecorder.start(500); // trozos cada 500ms
      isRecording = true;
      btn.textContent = 'Parar';
    } else {
      mediaRecorder.stop();
      socket.close();
      isRecording = false;
      btn.textContent = 'Hablar';
    }
  };
</script>

</body>
</html>
