<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agente de voz</title>
</head>
<body>
  <h1>Agente de voz (prueba)</h1>
  <button id="btnToggle">Hablar</button>
  <pre id="log"></pre>

  <script>
  const btn = document.getElementById('btnToggle');
  const log = document.getElementById('log');

  let mediaRecorder;
  let socket;
  let isRecording = false;

  function addLog(msg) {
    log.textContent += msg + "\n";
    console.log(msg);
  }

  async function startRecording() {
    // Comprobamos soporte de APIs
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      addLog("ERROR: navigator.mediaDevices.getUserMedia NO disponible.");
      addLog("Probablemente estás en HTTP (no HTTPS) o el navegador no permite el micro en este contexto.");
      return;
    }

    if (typeof MediaRecorder === "undefined") {
      addLog("ERROR: MediaRecorder NO está soportado en este navegador.");
      return;
    }

    try {
      addLog("Pidiendo permiso de micrófono...");
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      addLog("Permiso de micrófono CONCEDIDO.");

      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.onstart = () => {
        addLog("MediaRecorder iniciado");
      };

      mediaRecorder.ondataavailable = (e) => {
        addLog("Chunk de audio generado, tamaño: " + e.data.size);

        if (e.data.size > 0 && socket && socket.readyState === WebSocket.OPEN) {
          e.data.arrayBuffer().then(buf => {
            addLog("Enviando chunk de audio al servidor (" + buf.byteLength + " bytes)");
            socket.send(buf);
          });
        }
      };

      mediaRecorder.onstop = () => {
        addLog("MediaRecorder parado");
      };

      mediaRecorder.onerror = (e) => {
        addLog("MediaRecorder ERROR: " + e.error);
      };

      mediaRecorder.start(500); // trozos cada 500ms
      isRecording = true;
      btn.textContent = 'Parar';
    } catch (err) {
      addLog("ERROR al pedir el micrófono: " + err.name + " - " + err.message);
    }
  }

  btn.onclick = async () => {
    if (!isRecording) {
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      const wsUrl = `${protocol}://${location.host}`;
      addLog("Conectando WebSocket a: " + wsUrl);

      socket = new WebSocket(wsUrl);
      socket.binaryType = "arraybuffer";

      socket.onopen = () => {
        addLog("WS conectado");
        // Enviamos un mensaje de texto de prueba
        socket.send("TEST DESDE EL NAVEGADOR");
        // Una vez abierto el socket, empezamos a grabar
        startRecording();
      };

      socket.onmessage = (event) => {
        addLog("Respuesta servidor: " + event.data);
      };

      socket.onclose = () => addLog("WS cerrado");
      socket.onerror = (e) => addLog("WS error");
    } else {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }
      isRecording = false;
      btn.textContent = 'Hablar';
    }
  };
</script>



</body>
</html>
